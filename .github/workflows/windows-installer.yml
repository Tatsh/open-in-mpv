name: 'Windows Installer'

on:
  pull_request:
    branches:
      - 'master'
  push:
    branches:
      - 'master'
    tags:
      - 'v*.*.*'

permissions:
  attestations: 'write'
  contents: 'write'
  id-token: 'write'

jobs:
  build-installer:
    runs-on: 'windows-latest'
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v6'

      - name: 'Install Poetry'
        run: 'pipx install poetry yq'

      - name: 'Set up Python'
        uses: 'actions/setup-python@v6'
        with:
          cache: 'poetry'
          python-version: '3.13'

      - name: 'Install dependencies (Poetry)'
        run: |
          poetry install
          poetry run -- pip install pyinstaller
        shell: 'bash'

      - name: 'Build with PyInstaller'
        run: |
          poetry run -- pyinstaller --log-level ERROR --onefile -n "open-in-mpv" --optimize 1 --hidden-import colorlog -y open-in-mpv.spec
        shell: 'bash'

      - name: 'Download mpv'
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Write-Host "Downloading mpv..."
          Invoke-WebRequest -Uri "https://sourceforge.net/projects/mpv-player-windows/files/64bit/mpv-x86_64-latest.7z" -OutFile "$env:TEMP\mpv.7z"
          Write-Host "Extracting mpv..."
          7z x "$env:TEMP\mpv.7z" -o"$env:TEMP\mpv-extract"
          Write-Host "Finding mpv.exe..."
          $mpvExe = Get-ChildItem -Path "$env:TEMP\mpv-extract" -Filter "mpv.exe" -Recurse | Select-Object -First 1
          if ($mpvExe) {
            Copy-Item $mpvExe.FullName "dist\mpv.exe"
            Write-Host "mpv.exe copied to dist folder from $($mpvExe.FullName)"
          } else {
            Write-Error "mpv.exe not found in extracted archive"
            exit 1
          }
        shell: 'pwsh'

      - name: 'Install NSIS'
        run: |
          choco install nsis -y
        shell: 'pwsh'

      - name: 'Build installer'
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
        shell: 'pwsh'

      - name: 'Upload installer artifact'
        uses: 'actions/upload-artifact@v6'
        with:
          if-no-files-found: error
          name: open-in-mpv-installer
          path: 'open-in-mpv-installer.exe'

      - name: 'Attest installer'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: 'open-in-mpv-installer.exe'

      - if: github.ref_type == 'tag'
        name: 'Upload installer to release'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: 'open-in-mpv-installer.exe'
