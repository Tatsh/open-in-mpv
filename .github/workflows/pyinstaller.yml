jobs:
  build:
    runs-on: ${{ matrix.os }}
    steps:
      - uses: 'actions/checkout@v6'
      - name: 'Install Poetry'
        run: 'pipx install poetry yq'
      - name: 'Set up Python'
        uses: 'actions/setup-python@v6'
        with:
          cache: 'poetry'
          python-version: '3.13'
      - name: 'Install dependencies (Poetry)'
        run: |
          poetry install
          poetry run -- pip install pyinstaller
        shell: 'bash'
      - name: 'Build with PyInstaller'
        run: |
          project_name=$(tomlq -r '.project.urls.repository|split("/")[-1]' pyproject.toml)
          vers=$(echo "$(tomlq -r '.project.version|split(".")|map(tonumber)|@csv' pyproject.toml),0")
          version=$(tomlq -r .project.version pyproject.toml)
          while IFS=$' ' read -r script_name python_path func_name; do
              func_name="${func_name#"${func_name%%[![:space:]]*}"}"
              func_name="${func_name%"${func_name##*[![:space:]]}"}"
              cat > temp_script.py <<EOF
          from ${python_path} import ${func_name}
          if __name__ == '__main__':
              ${func_name}()
          EOF
              if [[ "${ACTIONS_RUNNER_DEBUG}" == 'true' ]]; then
                  cat temp_script.py
              fi
              cat > version-info.txt <<EOF
          VSVersionInfo(
              ffi=FixedFileInfo(date=(0, 0),
                                filevers=(${vers}),
                                fileType=0x1,
                                flags=0x0,
                                mask=0x3f,
                                OS=0x4,
                                prodvers=(${vers}),
                                subtype=0x0),
              kids=[
                  StringFileInfo([
                      StringTable('040904B0', [
                          StringStruct('CompanyName', 'Tatsh'),
                          StringStruct(
                              'FileDescription',
                              '${script_name} from ${project_name}. - ${{ github.server_url }}/${{ github.repository }}'
                          ),
                          StringStruct('FileVersion', '${version}'),
                          StringStruct('InternalName', '${script_name}.exe'),
                          StringStruct('LegalCopyright', 'Copyright (c) ${project_name} authors.'),
                          StringStruct('OriginalFilename', '${script_name}.exe'),
                          StringStruct('ProductName', '${project_name}'),
                          StringStruct('ProductVersion', '${version}')
                      ])
                  ]),
                  VarFileInfo([VarStruct('Translation', [0x409, 1200, 0x809, 1252])])
              ])
          EOF
              if [[ "${ACTIONS_RUNNER_DEBUG}" == 'true' ]]; then
                  cat version-info.txt
              fi
              echo "Building executable for '${script_name}'..."
              poetry run -- pyinstaller --log-level ERROR --onefile -n "${script_name}" --optimize 1 \
                --hidden-import colorlog -y --version-file version-info.txt \
                temp_script.py
              if [[ "${ACTIONS_RUNNER_DEBUG}" == 'true' ]]; then
                  cat "${script_name}.spec"
              fi
          done < <(tomlq -r '.project.scripts|to_entries[]|"\(.key) \(.value|split(":")|join(" "))"' pyproject.toml)
        shell: 'bash'
      - if: matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm'
        name: 'Test binary'
        run: |
          $distFiles = Get-ChildItem -Path dist\*.exe
          Write-Host "Found $($distFiles.Count) files in dist/: $(( $distFiles | ForEach-Object { $_.Name } ) -join ', ')"
          foreach ($file in $distFiles) {
            Write-Host "Testing '$($file.FullName)'."
            & $file.FullName --help
          }
      - if: matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel'
        name: 'Test binary'
        run: |
          dist_files=(dist/*)
          echo "Found ${#dist_files[@]} files in dist/: ${dist_files[*]##*/}"
          for file in "${dist_files[@]}"; do
              if [[ "${file}" == dist/index.*js ]]; then
                  echo "Skipping index.js."
                  continue
              fi
              echo "Testing '${file}'."
              "./${file}" --help
          done
      - name: 'Upload Artifacts'
        uses: 'actions/upload-artifact@v6'
        with:
          if-no-files-found: error
          name: open-in-mpv-binaries-${{ matrix.suffix }}
          path: |
            ${{ matrix.dist_path }}
      - name: 'Attest'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: '${{ matrix.dist_path }}'
      - if: (matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel') && github.ref_type == 'tag'
        name: 'Zip files'
        run: |
          rm -fR _out
          mkdir _out
          zip -j _out/open-in-mpv-${{ github.ref_name }}-${{ matrix.suffix }}.zip ${{ matrix.dist_path }}
      - if: (matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm') && github.ref_type == 'tag'
        name: 'Zip files'
        run: |
          Remove-Item -Force _out -ErrorAction Continue
          New-Item -ItemType Directory -Name _out
          Compress-Archive -Path ${{ matrix.dist_path }} -DestinationPath _out/open-in-mpv-${{ github.ref_name }}-${{ matrix.suffix }}.zip
        shell: pwsh
      - if: github.ref_type == 'tag'
        name: 'Attest'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: '_out/*.zip'
      - if: github.ref_type == 'tag'
        name: Upload package
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            _out/*.zip
    strategy:
      matrix:
        include:
          - os: 'macos-15-intel'
            dist_path: 'dist/*'
            suffix: 'mac-x86_64'
          - os: 'macos-latest'
            dist_path: 'dist/*'
            suffix: 'mac-arm64'
          - os: 'windows-latest'
            dist_path: 'dist/*.exe'
            suffix: 'win-x86_64'
          - os: 'windows-11-arm'
            dist_path: 'dist/*.exe'
            suffix: 'win-arm64'
  build-installer:
    runs-on: 'windows-latest'
    needs: build
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v6'
      - name: 'Download PyInstaller artifact'
        uses: 'actions/download-artifact@v7'
        with:
          name: open-in-mpv-binaries-win-x86_64
          path: dist
      - name: 'Install NSIS'
        run: |
          choco install nsis -y
        shell: 'pwsh'
      - name: 'Download and install Nsis7z plugin'
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/6/69/Nsis7z_19.00.7z" -OutFile "$env:TEMP\Nsis7z.7z"
          7z x "$env:TEMP\Nsis7z.7z" -o"$env:TEMP\Nsis7z"
          $pluginDir = "${env:ProgramFiles(x86)}\NSIS\Plugins"
          $pluginSubDir = "$pluginDir\x86-unicode"
          if (-not (Test-Path $pluginSubDir)) {
            New-Item -ItemType Directory -Path $pluginSubDir -Force | Out-Null
          }
          Copy-Item "$env:TEMP\Nsis7z\Plugins\x86-unicode\nsis7z.dll" "$pluginSubDir\nsis7z.dll"
        shell: 'pwsh'
      - name: 'Download and install Inetc plugin'
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/c/c9/Inetc.zip" -OutFile "$env:TEMP\Inetc.zip"
          Expand-Archive -Path "$env:TEMP\Inetc.zip" -DestinationPath "$env:TEMP\Inetc" -Force
          $pluginDir = "${env:ProgramFiles(x86)}\NSIS\Plugins"
          $pluginSubDir = "$pluginDir\x86-unicode"
          if (-not (Test-Path $pluginSubDir)) {
            New-Item -ItemType Directory -Path $pluginSubDir -Force | Out-Null
          }
          Copy-Item "$env:TEMP\Inetc\Plugins\x86-unicode\INetC.dll" "$pluginSubDir\INetC.dll"
        shell: 'pwsh'
      - name: 'Build installer'
        run: |
          & "${env:ProgramFiles(x86)}\NSIS\makensis.exe" installer.nsi
        shell: 'pwsh'
      - name: 'Upload installer artifact'
        uses: 'actions/upload-artifact@v6'
        with:
          if-no-files-found: error
          name: open-in-mpv-installer
          path: 'open-in-mpv-*-setup.exe'
      - name: 'Attest installer'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: 'open-in-mpv-*-setup.exe'
      - if: github.ref_type == 'tag'
        name: 'Upload installer to release'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: 'open-in-mpv-*-setup.exe'
  build-pkg:
    runs-on: 'macos-latest'
    needs: build
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v6'
      - name: 'Download PyInstaller artifact (ARM64)'
        uses: 'actions/download-artifact@v7'
        with:
          name: open-in-mpv-binaries-mac-arm64
          path: dist/arm64
      - name: 'Download PyInstaller artifact (x86_64)'
        uses: 'actions/download-artifact@v7'
        with:
          name: open-in-mpv-binaries-mac-x86_64
          path: dist/x86_64
      - name: 'Install Poetry and dependencies'
        run: |
          pipx install poetry yq
          poetry install
      - name: 'Create pkg structure'
        run: |
          version=$(tomlq -r .project.version pyproject.toml)
          mkdir -p pkg/arm64/scripts pkg/x86_64/scripts
          mkdir -p pkg/arm64/payload/usr/local/bin
          mkdir -p pkg/x86_64/payload/usr/local/bin
          cp dist/arm64/* pkg/arm64/payload/usr/local/bin/
          cp dist/x86_64/* pkg/x86_64/payload/usr/local/bin/
          chmod +x pkg/arm64/payload/usr/local/bin/*
          chmod +x pkg/x86_64/payload/usr/local/bin/*
          cat > pkg/postinstall <<'EOF'
          #!/bin/bash
          # Post-installation script for open-in-mpv
          /usr/local/bin/open-in-mpv-install --debug --exec-path /usr/local/bin/open-in-mpv --system --force || true
          if ! command -v mpv &> /dev/null; then
              echo "Warning: mpv is not installed. Please install it with 'brew install mpv', 'port install mpv +network', or from https://mpv.io/"
          fi
          if ! command -v yt-dlp &> /dev/null; then
              echo "Note: yt-dlp is not installed. For best results, install it with 'brew install yt-dlp', 'port install yt-dlp', or 'pip install yt-dlp'"
          fi
          exit 0
          EOF
          # Copy postinstall script to both architecture directories
          cp pkg/postinstall pkg/arm64/scripts/postinstall
          cp pkg/postinstall pkg/x86_64/scripts/postinstall
          # Make scripts executable
          chmod +x pkg/arm64/scripts/postinstall
          chmod +x pkg/x86_64/scripts/postinstall
          echo "PKG_VERSION=${version}" >> $GITHUB_ENV
      - name: 'Build pkg installers'
        run: |
          # Function to create distribution XML and build pkg
          build_pkg() {
            local arch=$1
            local component_pkg="open-in-mpv-${arch}-component.pkg"
            # Build component package
            pkgbuild --root "pkg/${arch}/payload" \
              --scripts "pkg/${arch}/scripts" \
              --identifier sh.tat.open-in-mpv \
              --version "${PKG_VERSION}" \
              --install-location / \
              "pkg/${component_pkg}"
            # Create distribution XML
            cat > "pkg/${arch}-distribution.xml" <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
            <title>open-in-mpv</title>
            <organization>sh.tat</organization>
            <domains enable_localSystem="true"/>
            <options customize="never" require-scripts="false" hostArchitectures="${arch}"/>
            <pkg-ref id="sh.tat.open-in-mpv"/>
            <choices-outline>
              <line choice="default">
                <line choice="sh.tat.open-in-mpv"/>
              </line>
            </choices-outline>
            <choice id="default"/>
            <choice id="sh.tat.open-in-mpv" visible="false">
              <pkg-ref id="sh.tat.open-in-mpv"/>
            </choice>
            <pkg-ref id="sh.tat.open-in-mpv" version="${PKG_VERSION}" onConclusion="none">${component_pkg}</pkg-ref>
          </installer-gui-script>
          EOF
            # Build product archive
            productbuild --distribution "pkg/${arch}-distribution.xml" \
              --package-path pkg \
              --version "${PKG_VERSION}" \
              "open-in-mpv-${PKG_VERSION}-${arch}.pkg"
          }
          # Build both architectures
          build_pkg arm64
          build_pkg x86_64
      - name: 'Upload pkg artifacts'
        uses: 'actions/upload-artifact@v6'
        with:
          if-no-files-found: error
          name: open-in-mpv-pkg-installers
          path: |
            open-in-mpv-*.pkg
      - name: 'Attest ARM64 pkg'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: 'open-in-mpv-*-arm64.pkg'
      - name: 'Attest x86_64 pkg'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: 'open-in-mpv-*-x86_64.pkg'
      - if: github.ref_type == 'tag'
        name: 'Upload pkg to release'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            open-in-mpv-*.pkg
name: 'PyInstaller'
'on':
  pull_request:
    branches:
      - 'master'
  push:
    branches:
      - 'master'
    tags:
      - 'v*.*.*'
permissions:
  attestations: 'write'
  contents: 'write'
  id-token: 'write'
