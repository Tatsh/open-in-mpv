jobs:
  build-pkg:
    runs-on: 'macos-latest'
    needs: build
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v6'
      - name: 'Download PyInstaller artifact (ARM64)'
        uses: 'actions/download-artifact@v7'
        with:
          name: open-in-mpv-binaries-mac-arm64
          path: dist/arm64
      - name: 'Download PyInstaller artifact (x86_64)'
        uses: 'actions/download-artifact@v7'
        with:
          name: open-in-mpv-binaries-mac-x86_64
          path: dist/x86_64
      - name: 'Install Poetry and dependencies'
        run: |
          pipx install poetry yq
          poetry install
      - name: 'Create pkg structure'
        run: |
          version=$(tomlq -r .project.version pyproject.toml)
          mkdir -p pkg/arm64/scripts pkg/x86_64/scripts
          mkdir -p pkg/arm64/payload/usr/local/bin
          mkdir -p pkg/x86_64/payload/usr/local/bin
          cp dist/arm64/* pkg/arm64/payload/usr/local/bin/
          cp dist/x86_64/* pkg/x86_64/payload/usr/local/bin/
          chmod +x pkg/arm64/payload/usr/local/bin/*
          chmod +x pkg/x86_64/payload/usr/local/bin/*
          cat > pkg/postinstall <<'EOF'
          #!/bin/bash
          # Post-installation script for open-in-mpv
          /usr/local/bin/open-in-mpv-install --debug --exec-path /usr/local/bin/open-in-mpv --system --force || true
          if ! command -v mpv &> /dev/null; then
              echo "Warning: mpv is not installed. Please install it with 'brew install mpv', 'port install mpv +network', or from https://mpv.io/"
          fi
          if ! command -v yt-dlp &> /dev/null; then
              echo "Note: yt-dlp is not installed. For best results, install it with 'brew install yt-dlp', 'port install yt-dlp', or 'pip install yt-dlp'"
          fi
          exit 0
          EOF
          # Copy postinstall script to both architecture directories
          cp pkg/postinstall pkg/arm64/scripts/postinstall
          cp pkg/postinstall pkg/x86_64/scripts/postinstall
          # Make scripts executable
          chmod +x pkg/arm64/scripts/postinstall
          chmod +x pkg/x86_64/scripts/postinstall
          echo "PKG_VERSION=${version}" >> $GITHUB_ENV
      - name: 'Build pkg installers'
        run: |
          # Function to create distribution XML and build pkg
          build_pkg() {
            local arch=$1
            local component_pkg="open-in-mpv-${arch}-component.pkg"
            # Build component package
            pkgbuild --root "pkg/${arch}/payload" \
              --scripts "pkg/${arch}/scripts" \
              --identifier sh.tat.open-in-mpv \
              --version "${PKG_VERSION}" \
              --install-location / \
              "pkg/${component_pkg}"
            # Create distribution XML
            cat > "pkg/${arch}-distribution.xml" <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
            <title>open-in-mpv</title>
            <organization>sh.tat</organization>
            <domains enable_localSystem="true"/>
            <options customize="never" require-scripts="false" hostArchitectures="${arch}"/>
            <pkg-ref id="sh.tat.open-in-mpv"/>
            <choices-outline>
              <line choice="default">
                <line choice="sh.tat.open-in-mpv"/>
              </line>
            </choices-outline>
            <choice id="default"/>
            <choice id="sh.tat.open-in-mpv" visible="false">
              <pkg-ref id="sh.tat.open-in-mpv"/>
            </choice>
            <pkg-ref id="sh.tat.open-in-mpv" version="${PKG_VERSION}" onConclusion="none">${component_pkg}</pkg-ref>
          </installer-gui-script>
          EOF
            # Build product archive
            productbuild --distribution "pkg/${arch}-distribution.xml" \
              --package-path pkg \
              --version "${PKG_VERSION}" \
              "open-in-mpv-${PKG_VERSION}-${arch}.pkg"
          }
          # Build both architectures
          build_pkg arm64
          build_pkg x86_64
      - name: 'Upload pkg artifacts'
        uses: 'actions/upload-artifact@v6'
        with:
          if-no-files-found: error
          name: open-in-mpv-pkg-installers
          path: |
            open-in-mpv-*.pkg
      - name: 'Attest ARM64 pkg'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: 'open-in-mpv-*-arm64.pkg'
      - name: 'Attest x86_64 pkg'
        uses: 'actions/attest-build-provenance@v3'
        with:
          subject-path: 'open-in-mpv-*-x86_64.pkg'
      - if: github.ref_type == 'tag'
        name: 'Upload pkg to release'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            open-in-mpv-*.pkg
name: 'macOS package'
'on':
  pull_request:
    branches:
      - 'master'
  push:
    branches:
      - 'master'
    tags:
      - 'v*.*.*'
permissions:
  attestations: 'write'
  contents: 'write'
  id-token: 'write'
